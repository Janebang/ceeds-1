---
title: "Highcharter"
author: "Julia Lee"
date: "3/2/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(RMySQL)
library(etl)
library(leaflet)
library(RSQLite)
library(ceeds)
library(macleish)
library(lubridate)
library(shinydashboard)
library(shiny)
library(highcharter)
library(timetk)
library(kableExtra)
```

```{r}
# fetching the data from the server
#using read_whately from ceeds package
mac_data <- read_whately()
whately <- purrr::pluck(mac_data, "whately")
orchard <- purrr::pluck(mac_data, "orchard")
```


```{r}
# Grouping by the date 
daily_whately <- get_daily(whately)
daily_orchard <- get_daily(orchard)
last_whately <- get_lastyear(daily_whately)
#getting current weather data
current<-tail(whately,1)
print(current[1,2])
```

```{r}
View(daily_whately)
```



# now putting all of these graphs in shiny dashboard:

```{r}
#setting up the ui of the dashboard
ui <- dashboardPage(
  # making a heading for the dashboard
  dashboardHeader(title = "Macleish weather",                
                  dropdownMenu()),
  #making a sidebar with tabs
  dashboardSidebar(
    # making a sidebar menu
    sidebarMenu(
      #making an id 
      id = "tabs",
      #creating menu items
      menuItem("Current Weather",tabName="Current Weather",icon=icon("globe")),
      menuItem("About", tabName = "About", icon = icon("dashboard")),
      menuItem("Historic Data", tabName = "Historic Data", icon = icon("bar-chart-o")),
      menuItem("Raw data",tabName="Raw data",icon=icon("globe"))      
    )),
  # Drawing the dashboard body
  dashboardBody(
    # tab items 
    tabItems(
tabItem(tabName = "Current Weather", h3("Current Weather",align="center"), 
        mainPanel(tableOutput("cw"), width=12)),
tabItem(tabName = "About", h3("About",align="center"), 
        box(leafletOutput("Abt"), width=12)),
tabItem(tabName = "Historic Data", h3("Historic Data",align="center"),
        fluidPage(
          splitLayout(cellWidths = c("25%", "25%","25%", "25%"),
          highchartOutput("hc2"), highchartOutput("hc3"), 
   highchartOutput("hc1"), highchartOutput("hc4")))),
  tabItem(tabName = "Historic Data", h3("Historic Data",align="center"),
  fluidPage(
    selectInput("dataset", "Dataset", c("Whately", "Orchard")),
  conditionalPanel( condition = "output.nrows",
                    checkboxInput("headonly", "Only use first 1000 rows"))
  
)
            
          )
              )#end tabItems
    )#end body
)



```



```{r}
# shiny server
server <- function(input, output,session){
# defining outputs
# output$name <- name = highchartOutput("name")
output$cw <- renderTable({
  current;
})
output$abt <- renderLeaflet({
   leaflet() %>%
  addTiles(group = "street") %>%
    addPolygons(data = macleish_layers[["boundary"]], 
              weight = 0.5, color = "lightgreen", group = "boundary") %>%
  addScaleBar(options = scaleBarOptions(maxWidth = 80, metric = FALSE, imperial = TRUE,
  updateWhenIdle = TRUE))
    
})
  output$hc1 <- renderHighchart ({
    highchart(type = "stock")%>%
      hc_add_series(daily_whately,type = "line", hcaes(y = avgTemp, x = the_date), 
                    name = "Avg temperature") %>%
      hc_add_series(daily_whately,type = "line", hcaes(y = mintemp, x = the_date), 
                    name = "min temperature") %>%
      hc_add_series(daily_whately,type = "line", hcaes(y = maxtemp, x = the_date), 
                    name = "max temperature") %>%
      hc_exporting(enabled = TRUE) # enable exporting option 
    })
  output$hc2 <- renderHighchart({highchart(type = "stock")%>%
      hc_add_series(daily_whately,type = "bar", hcaes(y = precipitation, 
            x = the_date), name = "precipitation") %>%
      hc_exporting(enabled = TRUE)})
  output$hc3 <-renderHighchart({highchart(type = "stock")%>%
      hc_add_series(daily_whately,type = "line", hcaes(y = maxwind, x = the_date)
                    , name = "Max Wind") %>%
      hc_exporting(enabled = TRUE)})
  output$hc4 <-renderPlot({
    ggplot(data = whately, aes(x = cut(wind_dir,15), fill = cut(wind_speed,15))) +
    geom_bar() + 
    scale_x_discrete(drop = FALSE, labels = waiver()) +
    coord_polar(start = -((30/2)/360) * 2*pi) +
   scale_colour_brewer(name = "Wind Speed (m/s)") })

 # download raw data 
  datasetInput <- reactive({
    switch(input$dataset,
           "Whately" = daily_whately,
           "Orchard" = daily_orchard)
  })
  output$nrows <- reactive({
    nrow(datasetInput())
  })
  
  outputOptions(output, "nrows", suspendWhenHidden = FALSE)  
# we want to switch tabs so we need to refresh session
# observeEvent allows reactive input and allows us to switch tabs
  observeEvent(input$switchtab, {
    newtab <- switch(input$tabs, "About" = "Historic Data",
                      "Historic Data" = "About", 
                     "About" = "Raw data",
                     "Raw data" = "About",
                     "Historic Data" = "Raw data", 
                     "Raw data" = "Historic Data",
                     "Current Weather" = "Historic Data", 
                     "Historic Data" = "Current Weather", 
                    "Current Weather" = "About", 
                    "About" = "Current Weather",
                     "Raw data" = "Current Weather",
                     "Current Weather" = "Raw data")
    #update tab items 
    updateTabItems(session, "tabs", newtab)
  })
  
}

```

```{r}
shinyApp(ui, server)
```
